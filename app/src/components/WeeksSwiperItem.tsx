import { makeStyles, Text } from "@rneui/themed";
import {
  endOfDay,
  endOfWeek,
  format,
  isThisWeek as isThisWeekUtil,
} from "date-fns";
import { ScrollView, View } from "react-native";
import { Defs, G, Mask, Path, Svg } from "react-native-svg";
import { Profile } from "~/hooks/useProfileQuery";
import { useWeekCaloriesAndWeightsQuery } from "~/hooks/useWeekCaloriesAndWeightsQuery";
import { WeekDay } from "~/typings";
import { Heading } from "./Heading";
import { WeekCaloriesAndWeights } from "./WeekCaloriesAndWeights";

interface WeeksSwiperItemProps {
  startOfWeekDate: Date;
  shouldLoad: boolean;
  profile: Profile;
  todayDate: Date;
}

export function WeeksSwiperItem({
  startOfWeekDate,
  shouldLoad,
  profile,
  todayDate,
}: WeeksSwiperItemProps) {
  const endOfWeekDate = endOfDay(
    endOfWeek(startOfWeekDate, {
      weekStartsOn: WeekDay.Monday,
    })
  );

  const isThisWeek = isThisWeekUtil(startOfWeekDate, {
    weekStartsOn: WeekDay.Monday,
  });

  const startOfWeekDateString = startOfWeekDate.toISOString();
  const endOfWeekDateString = endOfWeekDate.toISOString();
  const queryKey = ["weekCaloriesAndWeights", startOfWeekDateString];
  const {
    data: weekCaloriesAndWeights,
    isLoading,
    isError,
  } = useWeekCaloriesAndWeightsQuery({
    enabled: shouldLoad,
    profileId: profile.id,
    queryKey,
    startOfWeekDateString,
    endOfWeekDateString,
  });

  const weekText = isThisWeek
    ? `This week`
    : `${format(startOfWeekDate, "do' 'MMM")} - ${format(
        endOfWeekDate,
        "do' 'MMM"
      )}`;

  const styles = useStyles();

  return (
    <ScrollView style={styles.container}>
      <Shapes />

      <View style={styles.mainContainer}>
        <View style={styles.headingContainer}>
          <Heading type="h1">Home</Heading>
          <Heading type="h2">{weekText}</Heading>
        </View>

        {isError ? (
          <Text style={styles.error}>
            Something went wrong, try again later
          </Text>
        ) : (
          <WeekCaloriesAndWeights
            endOfWeekDate={endOfWeekDate}
            isThisWeek={isThisWeek}
            profile={profile}
            startOfWeekDate={startOfWeekDate}
            todayDate={todayDate}
            isLoading={isLoading}
            queryKey={queryKey}
            weekCaloriesAndWeights={weekCaloriesAndWeights}
          />
        )}
      </View>
    </ScrollView>
  );
}

const useStyles = makeStyles((theme) => ({
  container: {
    flex: 1,
  },
  headingContainer: {
    marginBottom: theme.spacing.sm,
  },
  mainContainer: {
    padding: theme.spacing.xl,
  },
  error: {
    color: theme.colors.error,
  },
}));

function Shapes() {
  return (
    <Svg
      width={600}
      height={2000}
      preserveAspectRatio="none"
      viewBox="0 0 600 2000"
      style={{ position: "absolute", top: -10 }}
    >
      <G mask='url("#SvgjsMask1046")' fill="none" strokeWidth={2}>
        <Path
          d="M412.5 0c31.29 42.86-16.95 82.37-2.98 150 4.78 23.11 18.56 31.48 40.48 31.48 31.01 0 60.07-2.35 65.38-31.48C526.6 88.39 459.04 42.56 483.05 0c18.3-32.44 91.33-32.86 116.95 0 32.86 42.14 0 75 0 150v1050c0 39.8 22.14 52.64 0 79.59-39.47 48.05-122.24 23.47-123.21 70.41-1.31 63.26 74.43 69.23 118.66 150 17.38 31.73 3.41 37.47 4.55 75 1.14 37.47 0 37.5 0 75v300c0 75 6.52 81.52 0 150-.62 6.52-7.33 1.55-14.29 0-68.04-15.21-69.76-33.53-135.71-33.53-35.04 0-31.02 25.65-66.28 33.53-39.74 8.88-41.86 0-83.72 0-52.94 0-81.78 30.99-105.88 0-34.23-44.01-8.72-74.91-10.79-150-2.06-74.91 12.4-76.89 2.54-150-6.8-50.42 1.65-83.41-35.87-97.06-55.42-20.17-101.26 46.61-150 29.41-26.26-9.27 0-41.17 0-82.35 0-38.89-15.21-45.03 0-77.78 19.61-42.25 69.64-33.75 69.64-72.22 0-45.2-45.88-43.94-69.64-95.12-11.06-23.82 0-27.44 0-54.88v-150-150c0-50.37-12.46-54.86 0-100.75 7.91-29.11 38.83-19.83 40.74-49.25 4.56-70.21-10.85-75.98-27.81-150C9.52 735.13 1.3 737.25 0 722.22-5.17 662.25 0 661.11 0 600V450c0-52.27-30.56-78.19 0-104.55 44.44-38.33 75.93-29.13 150-24.82 75.93 4.42 88.92 49.46 150 42.27 26.58-3.13 25.32-33.18 25.32-62.9 0-18.25-6.68-25.74-25.32-33.05-69.02-27.07-74.86-35.03-150-35.7-74.86-.66-107 56.33-150 33.04-32-17.33 0-57.15 0-114.29C0 75-37.5 37.5 0 0s75 0 150 0h150c56.25 0 89.03-32.14 112.5 0"
          stroke="rgba(124, 121, 135, 0.1)"
        />
        <Path
          d="M450 858.9c-19.87 0-39.47 20.75-39.47 41.1 0 19.93 19.6 39.47 39.47 39.47 20.14 0 40.54-19.53 40.54-39.47 0-20.34-20.41-41.1-40.54-41.1"
          stroke="rgba(238, 236, 164, 0.1)"
        />
        <Path
          d="M300 1128.57c-16.18 0-17.03 34.88-29.41 71.43-25.12 74.17-55.31 90.82-45.59 150 4.99 30.37 36.72 29.1 75 29.1 53.38 0 100.96 6.98 108.33-29.1 10.92-53.47-35.21-75.33-71.74-150-17.63-36.04-19.77-71.43-36.59-71.43M0 1841.57c45.41 0 145.16 51.45 145.16 108.43 0 60.61-101.38 126.76-145.16 126.76-28.8 0 0-63.38 0-126.76 0-54.22-27.17-108.43 0-108.43M81 0c37.56 49.12 55.33 91.36 33.71 150C95.83 201.18 37.76 219.64 0 219.64c-19.6 0 0-34.82 0-69.64C0 75-26.3 48.7 0 0c14.2-26.3 61.21-25.88 81 0"
          stroke="rgba(124, 121, 135, 0.1)"
        />
        <Path
          d="M204.55 150c-16.64-59.61 3.76-95.11 38.69-150 12.8-20.11 28.38 0 56.76 0 20.19 0 35.09-15.88 40.38 0 19.71 59.12 23.2 81.59 9.62 150-6.61 33.29-20.85 53.39-50 53.39-43.58 0-83.71-11.3-95.45-53.39"
          stroke="rgba(104, 96, 164, 0.1)"
        />
        <Path
          d="M600 131.25c-13.86 0-53.39-83.59-53.39-131.25 0-17.96 45.67-18.98 53.39 0 18.98 46.65 12.84 131.25 0 131.25"
          stroke="rgba(124, 121, 135, 0.1)"
        />
        <Path
          d="M374.03 300c24.23-44.56 34.87-72.22 75.97-72.22 51.05 0 65.17 26.54 108.33 72.22 31.84 33.7 29.12 41.38 41.67 86.54 8.29 29.84 0 31.73 0 63.46v750c0 1.53 1.47 2.72 0 3.06-73.53 16.97-82.17 32.77-150 31.56-18.14-.32-11.94-16.74-21.95-34.62-41.66-74.43-35.21-79.09-81.38-150-17.86-27.42-16.97-43.77-46.67-46.67-68.63-6.71-77.05 8.53-150 27.44-17.05 4.42-30 7.33-30 19.23 0 15.57 19.44 15.16 30 35.71 27.97 54.45 47.06 58.46 47.06 114.29 0 44.17-8.83 62.1-47.06 85.71-60.3 37.24-108.08 59.95-150 35.99-33.08-18.9 0-60.85 0-121.7v-150c0-22.39-10.75-26.26 0-44.78C32.77 948.74 68.57 960.75 87.04 900c20.33-66.86 6.43-77.38-9.45-150-16.92-77.38-23.22-78.36-56.16-150-5.86-12.74-19.52-5.38-21.43-18.75-8.8-61.63 0-65.62 0-131.25 0-23.87-17.75-37.97 0-47.73 57.25-31.49 80.03-46.72 150-34.77 69.74 11.91 66.18 39.37 129.41 82.5 11.77 8.03 9.45 19.81 20.59 19.81 13.74 0 22.37-4.2 29.17-19.81 30.21-69.3 8.67-83.45 44.86-150"
          stroke="rgba(238, 236, 164, 0.1)"
        />
        <Path
          d="M450 807.53c-44.72 0-88.82 46.68-88.82 92.47 0 44.86 44.11 88.82 88.82 88.82 45.31 0 91.22-43.95 91.22-88.82 0-45.78-45.92-92.47-91.22-92.47M136.61 1500c0-22.01-5.68-36.54 13.39-44.12 62.63-24.89 75.59-7.16 150-20.81 75.59-13.87 86-51.63 150-34.22 55.32 15.05 88.64 46.44 88.64 99.15 0 63.34-43.43 67.15-88.64 132.95-6.32 9.2-14.42 8.72-14.42 17.05 0 7.85 7.71 7.22 14.42 15.31 55.5 66.91 82.5 58.31 110 134.69 23.75 65.96 22.47 89.43-7.5 150-25.03 50.6-51.11 72.35-102.5 72.35-51.98 0-54.04-33.8-104.24-72.35-24.8-19.05-26.36-18.44-45.76-42.86-40.17-50.58-46.72-48.81-73.37-107.14-32.1-70.24-21.9-75.05-44.13-150-16.08-54.21-15.96-54.26-32.5-108.33-6.4-20.93-13.39-20.78-13.39-41.67M0 1641.67c10.95 0 28.12 4.05 28.12 8.33 0 4.3-17.3 8.82-28.12 8.82-3.24 0 0-4.41 0-8.82 0-4.16-3.11-8.33 0-8.33"
          stroke="rgba(104, 96, 164, 0.1)"
        />
        <Path
          d="M0 1886.75c26.49 0 84.68 30.01 84.68 63.25 0 35.35-59.14 73.94-84.68 73.94-16.8 0 0-36.97 0-73.94 0-31.62-15.85-63.25 0-63.25M6 0c19.82 72.19 37.47 83.34 35.18 150-.71 20.84-27.62 25-41.18 25-7.03 0 0-12.5 0-25C0 75-2.88 72.12 0 0c.12-2.88 5.23-2.81 6 0"
          stroke="rgba(238, 236, 164, 0.1)"
        />
        <Path
          d="M422.73 300c1.67-17.61 12.52-25.93 27.27-25.93 18.33 0 34.93 5.04 38.89 25.93 12.71 67.08-15.53 76.68-5.56 150 10.43 76.68 50.3 76.28 46.36 150-4.07 76.28-26.58 79.85-62.38 150-4.05 7.93-8.25 6.16-17.31 6.16-37.1 0-38.01-.02-75-6.16-38.01-6.31-37.5-18.75-75-18.75s-75 2.88-75 18.75c0 18.5 54.49 14.58 75 50 22.91 39.58 11.84 51.25 11.84 100 0 11.25-1.03 17.69-11.84 20-70.11 15-83.6 22.59-150 14.62-16.93-2.03-15.88-15.82-16.67-34.62-3.09-73.51 2.52-75.22 8.91-150 1.94-22.72 1.18-23.21 7.76-45 16.05-53.21 37.5-56.35 37.5-105 0-24.04-17.33-21.64-37.5-40.38C89.46 503.36 26.09 490.81 26.09 450c0-31.81 64.53-35.62 123.91-35.62 30.52 0 30.64 14.38 55.88 35.62 49.76 41.86 43.21 90.57 94.12 90.57 62.82 0 101.58-28.34 133.33-90.57 29.62-58.06-17.27-79.64-10.6-150M591.89 900c8-8.56 6.02-22.22 8.11-22.22 1.96 0 0 11.11 0 22.22v150c0 35.87 23.81 66.02 0 71.74-51.19 12.28-82.92-7.43-150-35.74-17.92-7.56-20-20.71-20-36 0-8.63 11.5-3.96 20-11.84 72.44-67.12 74.89-66.53 141.89-138.16M0 1082.61c28.39 0 100 68.68 100 117.39 0 35.45-65.61 50.94-100 50.94-15.61 0 0-25.47 0-50.94 0-58.7-21.61-117.39 0-117.39"
          stroke="rgba(104, 96, 164, 0.1)"
        />
        <Path
          d="M275 1500c4.07-11.76 12.01-6.32 25-8.96 74.51-15.15 80.78-30.04 150-26.63 21.69 1.07 31.82 16.67 31.82 35.59 0 22.74-14.08 25.24-31.82 47.73-41.44 52.51-86.54 52.29-86.54 102.27 0 47.08 44.52 44.82 86.54 91.84 25 27.98 40.83 23.47 47.5 58.16 13.33 69.39 10.41 82.79-7.5 150-5.84 21.91-19.94 28.24-40 28.24-20.28 0-22.04-12.01-40.68-28.24-56.36-49.08-58.09-48.24-109.32-102.38-19.74-20.86-25.03-20.38-32.61-47.62-19.92-71.57-24.28-75.32-22.39-150 1.91-75.32 6.57-82.28 30-150M0 1931.93c7.57 0 24.19 8.57 24.19 18.07 0 10.1-16.89 21.13-24.19 21.13-4.8 0 0-10.56 0-21.13 0-9.03-4.53-18.07 0-18.07"
          stroke="rgba(124, 121, 135, 0.1)"
        />
      </G>
      <Defs>
        <Mask id="SvgjsMask1046">
          <Path fill="#fff" d="M0 0H600V2000H0z" />
        </Mask>
      </Defs>
    </Svg>
  );
}
